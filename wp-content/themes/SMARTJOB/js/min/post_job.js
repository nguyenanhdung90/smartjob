jQuery(document).ready(function(e){jQuery.validator.addMethod("username",function(e,t){var n=/^[A-Za-z0-9_]{1,20}$/;return n.test(e)});JobEngine.Views.Post_Job=Backbone.View.extend({el:e("div#post_job"),job:{},tpl_login_success:null,events:{"click div.toggle-title":"selectStep","click div#step_auth .tab-title > div":"selectTab","submit div#step_auth form":"submitAuth","click div.login_success a#logout_link":"logoutCompany","keypress input#full_location":"geocoding","blur input#full_location":"resetLocation","submit form#job_form":"submitJob","click button.select_plan":"selectPlan","click button.select_payment":"selectPayment"},initialize:function(){_.bindAll(this);this.setupView();var e=this.$("#job_data").html();if(!!e){e=JSON.parse(e)}this.job=new JobEngine.Models.Job(e);this.job.author=JobEngine.app.currentUser;this.job.author.on("change",this.job.updateJobAuthor,this.job);this.job.author.on("change:id",this.updateAuthor,this);this.job.on("change:is_free",this.updateProcess,this);if(this.job.get("job_paid")==="2"){this.removePaymentStep()}if(this.job.author.has("id")){this.logo_uploader.updateConfig({multipart_params:{author:this.job.author.get("id")}})}this.job.on("change:job_package",function(){if(!this.isNew()){this.save()}});this.loadingBtn=null;pubsub.on("je:response:auth",this.updateLogoNonce,this);this.bind("waitingPostJob",this.waitingPostJob,this);this.bind("endWaitingPostJob",this.endWaitingPostJob,this);this.bind("waitingAuth",this.waitingAuth,this);this.bind("endWaitingAuth",this.endWaitingAuth,this);this.bind("waitingPayment",this.waitingPayment,this);this.bind("endwaitingPayment",this.endWaitingPayment,this)},setupView:function(){var t=this,n=this.$("#user_logo_container");if(typeof this.map==="undefined"){this.map=new GMaps({div:"#map",lat:10.7966064,lng:106.6902172,zoom:12,panControl:false,zoomControl:false,mapTypeControl:false});if(e("#location_lat").val()!==""&&e("#location_lng").val()!==""){var r=e("#location_lat").val(),i=e("#location_lng").val();this.map.setCenter(r,i);this.map.addMarker({lat:r,lng:i,draggable:true,dragend:function(e){console.log(e.position);t.$("#location_lat").val(e.position.Xa);t.$("#location_lng").val(e.position.Ya)}})}}var s=new JobEngine.Views.BlockUi;this.logo_uploader=new JobEngine.Views.File_Uploader({el:n,uploaderID:"user_logo",thumbsize:"company-logo",multipart_params:{_ajax_nonce:n.find(".et_ajaxnonce").attr("id"),action:"et_logo_upload"},cbUploaded:function(e,n,r){if(r.success){t.job.author.set("user_logo",r.data,{silent:true})}else{pubsub.trigger("je:notification",{msg:r.msg,notice_type:"error"})}},beforeSend:function(e){s.block(n.find(".company-thumbs"))},success:function(){s.unblock()}});this.register_validator=this.$("form#register").validate({rules:{reg_user_name:{required:true,username:true},reg_email:{required:true,email:true},reg_pass:"required",reg_pass_again:{required:true,equalTo:"#reg_pass"}},messages:{reg_user_name:{username:et_post_job.reg_user_name}}});this.login_validator=this.$("form#login").validate({rules:{log_email:"required",log_pass:"required"}});this.job_form_validator=this.$("form#job_form").validate({rules:{title:"required",full_location:"required",display_name:"required",content:"required",user_url:{required:true,url:true}}});tinyMCE.execCommand("mceAddControl",false,"content");this.tpl_login_success=new _.template('<div class="login_success">'+et_globals.msg_login_ok+'<span><a id="logout_link" href="#">'+et_globals.msg_logout+"</a></span>"+"</div>");this.$("div#step_auth").find(".tab-content > div:not(.current)").hide();this.$("div.step:not(.current)").find(".toggle-content").hide();return this},selectStep:function(e){var t=this.$(e.currentTarget).closest("div.step"),n=this.$("div.step.current").index(),r=true;if(!t.hasClass("current")){t.prevAll().each(function(e,t){if(!jQuery(t).hasClass("completed")){r=false;return false}});if(r||t.index()<n){this.showStep(t)}else{pubsub.trigger("je:notification",{msg:et_post_job.notice_step_not_allowed,notice_type:"error"})}}},reloadMap:function(e){var t=this,n=_.extend({},e);n.callback=function(n,r){var i,s,o;if(r=="OK"){s=t.$("#location_lat"),o=t.$("#location_lng");i=n[0].geometry.location;t.map.setCenter(i.lat(),i.lng());t.map.removeMarkers();t.map.addMarker({lat:i.lat(),lng:i.lng(),draggable:true,dragend:function(e){s.val(e.position.Xa);o.val(e.position.Ya)}});s.val(i.lat());o.val(i.lng())}if(typeof e.callback==="function"){e.callback()}};GMaps.geocode(n)},showStep:function(t){var n=this;this.$("div.step").removeClass("current").find(".toggle-content").slideUp(200).end().find(".toggle-title").removeClass("bg-toggle-active");t.addClass("current").find(".toggle-title").addClass("bg-toggle-active").next().slideToggle(300);if(t.attr("id")==="step_job"&&typeof this.map.refresh==="function"){this.map.refresh();if(e("#location_lat").val()!==""&&e("#location_lng").val()!==""){this.map.setCenter(e("#location_lat").val(),e("#location_lng").val())}if(this.job.has("location_lat")&&this.job.has("location_lng")){this.reloadMap({lat:this.job.get("location_lat"),lng:this.job.get("location_lng")})}}return this},geocoding:function(t){var n=this,r=e(t.currentTarget);if(typeof this.t!=="undefined"){clearTimeout(this.t)}this.t=setTimeout(function(){n.reloadMap({address:e.trim(r.val())})},500)},resetLocation:function(t){var n=e(t.currentTarget),r=this.$("#location_lat"),i=this.$("#location_lng"),s=this.$("#location");if(e.trim(n.val())===""){r.val("");i.val("");s.val("")}else{GMaps.geocode({lat:r.val(),lng:i.val(),callback:function(e,t){var r,i,o,u,a,f;if(t=="OK"){r=e[0].address_components.length;i=e[0].address_components;o=e[0].formatted_address;u=" ";a=" ";for(f=0;f<r;f++){if(i[f].types[0]=="administrative_area_level_2"&&i[f].long_name!=="undefined"){u=i[f].long_name+", "}if(i[f].types[0]=="administrative_area_level_1"&&i[f].long_name!=="undefined"){a=i[f].long_name}}s.val(u+a);n.val(o)}}})}},markStepCompleted:function(e){if(!e.hasClass("completed")){e.addClass("completed").find(".toggle-title").addClass("toggle-complete")}return this},markStepIncompleted:function(e){if(e.hasClass("completed")){e.removeClass("completed").find(".toggle-title").removeClass("toggle-complete")}return this},selectPlan:function(t){var n=e(t.currentTarget),r=n.closest("li"),i=r.closest("div.step"),s=i.nextAll().not(".completed").first(),o=n.attr("data-price"),u=n.attr("data-package");if(!r.hasClass("selected")){r.addClass("selected").siblings().removeClass("selected");this.job.set({job_package:u});if(parseInt(o,10)===0){this.job.set({is_free:1})}else{this.job.set({is_free:0})}}if(!!this.job.get("job_package")){this.markStepCompleted(i)}if(s.is(":visible")){this.showStep(s)}else{this.showStep(i.next())}},updateProcess:function(){var e=this.job.get("is_free");if(e===1){this.removePaymentStep()}else{this.showPaymentStep()}},removePaymentStep:function(){this.$("#step_payment").hide();this.$("#step_job #submit_job").html(et_post_job.button_submit)},showPaymentStep:function(){this.$("#step_payment").show();this.$("#step_job #submit_job").html(et_post_job.button_continue)},selectTab:function(e){var t=this.$(e.currentTarget),n=t.index();if(!t.hasClass("active")){t.siblings().removeClass("active").end().addClass("active");this.$(".tab-content > div").hide().eq(n).fadeIn(200).find("input:first").focus()}return false},submitAuth:function(e){e.preventDefault();var t=this.$(e.currentTarget),n=t.closest("div.form"),r=t.attr("id"),i=this,s;if(this[r+"_validator"].form()){JobEngine.app.auth.setUserName(n.find("input.is_user_name").val());JobEngine.app.auth.setEmail(n.find("input.is_email").val());JobEngine.app.auth.setPass(n.find("input.is_pass").val());s=JobEngine.app.auth.doAuth(r,{renew_logo_nonce:true,beforeSend:function(){i.loadingBtn=new JobEngine.Views.LoadingButton({el:t.find("button[type=submit]")});i.loadingBtn.loading()},success:function(){i.loadingBtn.finish()}})}},waitingAuth:function(t){console.log(e(t))},endWaitingAuth:function(e){this.loadingBtn.finish()},logoutCompany:function(t){t.preventDefault();var n=e("<img>").attr({alt:"loading",src:et_globals.imgURL+"/loading.gif","class":"loading"});JobEngine.app.auth.doLogout({beforeSend:function(){n.insertAfter(e(t.currentTarget))},success:function(){n.remove()}})},updateAuthor:function(){var t=this.$("div#step_auth"),n=this.$("div#step_job"),r=t.prevAll(),i=null;if(t.length>0){r.each(function(e,t){var n=jQuery(t);if(!n.hasClass("completed")&&i===null){i=n;return false}});if(!this.job.author.isNew()){if(!t.hasClass("completed")){this.$("div#step_auth .toggle-content").children("div").hide().end().append(this.tpl_login_success({company:this.job.author.get("display_name")}));this.markStepCompleted(t);if(i===null){this.showStep(t.nextAll().not(".completed").first())}}this.logo_uploader.updateConfig({multipart_params:{author:this.job.author.id},updateThumbnail:true,data:this.job.author.get("user_logo")})}else{this.markStepIncompleted(t).markStepIncompleted(n);if(i===null){this.showStep(t)}this.$("div#step_auth .toggle-content").children("div.login_success").fadeOut(200,function(){e(this).remove()}).end().children("div").fadeIn(400)}}else{if(this.job.author.isNew()){window.location.reload()}}this.updateCompany()},updateLogoNonce:function(e,t,n){if(e.logo_nonce){this.logo_uploader.updateConfig({multipart_params:{_ajax_nonce:e.logo_nonce}})}},updateCompany:function(){var e=this.job.author.get("user_logo"),t=this.$("form#job_form");t.find("input#display_name").val(this.job.author.getName()).end().find("input#user_url").val(this.job.author.getUrl());if(!!e&&"company_logo"in e&&!!e["company_logo"]){t.find("img#user_logo_thumb").attr({src:e["company_logo"][0]})}},submitJob:function(t){t.preventDefault();var n=this,r=this.$(t.currentTarget).closest("div.form"),i=r.find("div#job_info"),s=r.closest("div.step"),o={},u={};if(this.job_form_validator.form()){r.find("div#company_info input").each(function(){var t=e(this);o[t.attr("id")]=t.val()});this.job.author.set(o);i.find("input,textarea").each(function(){var t=e(this);u[t.attr("id")]=t.val()});u["job_types"]=[{slug:i.find("select#job_types").val()}];u["categories"]=[{slug:i.find("select#categories").val()}];this.job.set(u,{silent:true}).save({},{author_sync:true,beforeSend:function(){n.loadingBtn=new JobEngine.Views.LoadingButton({el:e("button#submit_job")});n.loadingBtn.loading()},success:function(e,t){n.loadingBtn.finish();if(t.success){if(t.success_url){window.location=t.success_url}else{n.markStepCompleted(s).showStep(s.nextAll().not(".completed").first())}}}})}},waitingPostJob:function(){console.log(this.loadingBtn)},endWaitingPostJob:function(){this.loadingBtn.finish()},selectPayment:function(t){t.preventDefault();var n=this;var r={type:"POST",dataType:"json",url:et_globals.ajaxURL,contentType:"application/x-www-form-urlencoded;charset=UTF-8",data:{action:"et_payment_process",jobID:this.job.id,authorID:this.job.get("author_id"),packageID:this.job.get("job_package"),paymentType:this.$(t.currentTarget).attr("data-gateway")},beforeSend:function(){n.trigger("waitingPayment",t.currentTarget)},success:function(r){n.trigger("endWaitingPayment",t.currentTarget);if(r.data.ACK){e(t.currentTarget).parents("form").attr("action",r.data.url);if(r.paymentType=="googleco"){e(t.currentTarget).parents("form").append(r.data.extend.extend_fields)}e(t.currentTarget).parents("form").submit()}}};jQuery.ajax(r)},waitingPayment:function(t){this.loadingBtn=new JobEngine.Views.LoadingButton({el:e(t)});this.loadingBtn.loading()},endWaitingPayment:function(){this.loadingBtn.finish()}});new JobEngine.Views.Post_Job})