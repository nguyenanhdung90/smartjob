var JobEngine=JobEngine||{};JobEngine.Models=JobEngine.Models||{};JobEngine.Collections=JobEngine.Collections||{};JobEngine.Views=JobEngine.Views||{};JobEngine.Routers=JobEngine.Routers||{};JobEngine.pubsub=JobEngine.pubsub||{};_.extend(JobEngine.pubsub,Backbone.Events);var pubsub=pubsub||JobEngine.pubsub;JobEngine.ajaxParams={type:"POST",dataType:"json",url:et_globals.ajaxURL,contentType:"application/x-www-form-urlencoded;charset=UTF-8"};var ajaxParams=JobEngine.ajaxParams;JobEngine.Models.Job=Backbone.Model.extend({author:{},action:"et_job_sync",initialize:function(){_.bindAll(this);if(this.has("author_id")){this.author=new JobEngine.Models.Company({id:this.get("author_id")})}else{this.author=new JobEngine.Models.Company}this.author.on("change",this.updateJobAuthor,this)},updateJobAuthor:function(){if(this.author.hasChanged("id")||!this.has("author_id")){this.set("author_id",this.author.id,{silent:true})}this.set("author_data",{user_url:this.author.get("user_url"),display_name:this.author.get("display_name"),user_logo:this.author.get("user_logo"),post_url:this.author.get("post_url")},{silent:true})},parse:function(e){if(!e.success){pubsub.trigger("je:notification",{msg:e.msg,notice_type:"error"});return{}}else{if(e.method==="create"){this.set("id",e.data.job.id,{silent:true});return{}}else{pubsub.trigger("je:notification",{msg:e.msg,notice_type:"success"});if("author"in e.data){this.author.set(e.data.author,{silent:true});this.set("author_data",{user_url:this.author.get("user_url"),display_name:this.author.get("display_name"),user_logo:this.author.get("user_logo"),post_url:this.author.get("post_url"),recent_location:this.author.get("recent_location")},{silent:true})}return e.data.job}}},sync:function(e,t,n){var r=_.extend({type:"POST",dataType:"json",url:et_globals.ajaxURL,contentType:"application/x-www-form-urlencoded;charset=UTF-8",author_sync:false},n||{}),i;e=n&&n.method?n.method:e;if(e==="read"){r.type="GET";r.data={id:t.id}}if(!r.data&&t&&(e==="create"||e==="update"||e==="delete")){i=_.clone(t.attributes);if(!r.author_sync){delete i.author_data}if("author_data"in i&&"user_logo"in i.author_data){delete i.author_data.user_logo}r.data=i}r.data=jQuery.param({action:t.action,method:e,content:r.data});return jQuery.ajax(r)},reviewJob:function(e,t){t=t||{};this.set("status",e,{silent:true});t.data=_.extend("data"in t?t.data:{},{id:this.get("id"),status:e,method:"reviewJob"});t.method="reviewJob";this.save({status:e,method:"reviewJob"},t)},approve:function(e){e=e||{};var t=e&&typeof e.success==="function"?e.success:false;e.success=function(e,n){pubsub.trigger("je:job:afterApproveJob",e,n);if(t){t(e,n)}};e.wait=true;this.reviewJob("publish",e)},reject:function(e){e=e||{};var t=e&&typeof e.beforeSend==="function"?e.beforeSend:false,n=e&&typeof e.success==="function"?e.success:false;e.beforeSend=function(){pubsub.trigger("je:request:waiting");if(t){t()}};e.success=function(e,t){pubsub.trigger("je:job:afterRejectJob",e,t);if(n){n(e,t)}};this.reviewJob("reject",e)},archive:function(e){e=e||{};var t=this.get("status"),n=typeof e.success==="function"?e.success:false;e.success=function(e,r){pubsub.trigger("je:job:afterArchiveJob",e,r,t);if(n){n(e,r)}};this.reviewJob("trash",e)}});JobEngine.Models.Company=Backbone.Model.extend({defaults:{display_name:"",user_url:"",post_url:"",recent_location:""},action:"et_company_sync",initialize:function(){_.bindAll(this)},parse:function(e){if(!e.success){pubsub.trigger("je:error:user_sync",e);return{}}else{return e.data}},renderListItem:function(){return this.itemTemplate(this.toJSON)},setName:function(e){this.set({display_name:e},{silent:true})},getName:function(){return this.get("display_name")},setUrl:function(e){this.set({user_url:e},{silent:true})},getUrl:function(){return this.get("user_url")},setLocation:function(e){this.set({recent_location:e},{silent:true})},getLocation:function(){return this.get("recent_location")},sync:function(e,t,n){var r=_.extend({type:"POST",dataType:"json",url:et_globals.ajaxURL,contentType:"application/x-www-form-urlencoded;charset=UTF-8"},n||{});if(e=="read"){r.type="GET";r.action=t.action;r.data={id:t.id?t.id:"",login_name:t.login_name?t.login_name:""}}if(!r.data&&t&&(e=="create"||e=="update"||e=="delete")){r.action=t.action;r.data=t.toJSON()}if(r.type!=="GET"){r.processData=false}r.data=jQuery.param({action:r.action,method:e,content:r.data});return jQuery.ajax(r)}});JobEngine.Collections.Jobs=Backbone.Collection.extend({model:JobEngine.Models.Job,list_title:"",fetchData:{paged:1,job_type:"",job_category:"",s:"",location:""},action:"et_fetch_jobs",paginateData:{},comparator:function(e){var t=new Date(e.get("post_date"));return-parseInt(e.get("featured")+""+t.getTime(),10)},setData:function(e){this.fetchData=e;if(!("paged"in this.fetchData)){this.fetchData.paged=1}return this},nextPage:function(e){var t=this,n;if(!("paged"in this.fetchData)){this.fetchData.paged=2}else{this.fetchData.paged++}n=_.extend({data:this.fetchData,add:true},e||{});n.beforeSend=function(){t.trigger("nextPageBeforeSend");if(e&&typeof e.beforeSend==="function"){e.beforeSend()}};n.success=function(n,r){t.trigger("nextPageSuccess");if(e&&typeof e.success==="function"){e.success(n,r)}};this.fetch(n)},filter:function(e){var t=this,n=_.extend({data:_.extend(this.fetchData,{paged:1})},e||{});n.beforeSend=function(){t.trigger("filterBeforeSend");if(e&&typeof e.beforeSend==="function"){e.beforeSend()}};n.success=function(n,r){t.trigger("filterSuccess");if(e&&typeof e.success==="function"){e.success(n,r)}};this.fetch(n)},parse:function(e){if(e.data){if("list_title"in e.data){this.list_title=e.data.list_title}this.paginateData=_.clone(e.data);delete this.paginateData.jobs;return _.map(e.data.jobs,function(t){var n=new JobEngine.Models.Job(t);if(t.author_id in e.data.authors){n.author.set(e.data.authors[t.author_id],{silent:true});n.updateJobAuthor()}return n})}},sync:function(e,t,n){var r=_.extend({type:"POST",dataType:"json",url:et_globals.ajaxURL,contentType:"application/x-www-form-urlencoded;charset=UTF-8"},n||{});if(e=="read"){r.type="GET";r.data=_.extend(r.data,t.JSON)}if(!r.data&&t&&(e=="create"||e=="update"||e=="delete")){r.data=t.toJSON()}if(r.type!=="GET"){r.processData=false}r.action=t.action;r.data=jQuery.param({action:r.action,method:e,content:r.data});return jQuery.ajax(r)}});JobEngine.Collections.Companies=Backbone.Collection.extend({model:JobEngine.Models.Company,initialize:function(){}});JobEngine.Views.File_Uploader=Backbone.View.extend({initialize:function(){_.bindAll(this);this.uploaderID=this.options.uploaderID?this.options.uploaderID:"et_uploader";this.config={runtimes:"gears,html5,flash,silverlight,browserplus,html4",multiple_queues:true,multipart:true,urlstream_upload:true,multi_selection:false,upload_later:false,container:this.uploaderID+"_container",browse_button:this.uploaderID+"_browse_button",thumbnail:this.uploaderID+"_thumbnail",thumbsize:"thumbnail",file_data_name:this.uploaderID,filters:[{title:"Image Files",extensions:"jpg,jpeg,gif,png"}],multipart_params:{fileID:this.uploaderID}};jQuery.extend(true,this.config,et_globals.plupload_config,this.options);this.controller=new plupload.Uploader(this.config);this.controller.init();this.controller.bind("FileUploaded",this.onFileUploaded);this.controller.bind("FilesAdded",this.onFileAdded);this.controller.bind("BeforeUpload",this.onFilesBeforeSend);this.bind("UploadSuccessfully",this.onUploadComplete);if(typeof this.controller.settings.onProgress==="function"){this.controller.bind("UploadProgress",this.controller.settings.onProgress)}if(typeof this.controller.settings.onError==="function"){this.controller.bind("Error",this.controller.settings.onError)}if(typeof this.controller.settings.cbRemoved==="function"){this.controller.bind("FilesRemoved",this.controller.settings.cbRemoved)}},onFileAdded:function(e,t){if(typeof this.controller.settings.cbAdded==="function"){this.controller.settings.cbAdded(e,t)}if(!this.controller.settings.upload_later){e.refresh();e.start()}},onFileUploaded:function(e,t,n){n=$.parseJSON(n.response);if(typeof this.controller.settings.cbUploaded==="function"){this.controller.settings.cbUploaded(e,t,n)}if(n.success){this.updateThumbnail(n.data);this.trigger("UploadSuccessfully",n)}},updateThumbnail:function(e){var t=this,n=this.$("#"+this.controller.settings["thumbnail"]),r,i;if(n.length>0){r=n.find("img"),i=this.controller.settings["thumbsize"];if(r.length>0){r.fadeOut(100,function(){r.remove();if(_.isArray(e[i])){t.insertThumb(e[i][0],n)}})}else if(_.isArray(e[i])){this.insertThumb(e[i][0],n)}}},insertThumb:function(e,t){jQuery("<img>").attr({id:this.uploaderID+"_thumb",src:e}).hide().appendTo(t).fadeIn(300)},updateConfig:function(e){if("updateThumbnail"in e&&"data"in e){this.updateThumbnail(e.data)}$.extend(true,this.controller.settings,e);this.controller.refresh()},onFilesBeforeSend:function(){if("beforeSend"in this.options&&typeof this.options.beforeSend==="function"){this.options.beforeSend(this.$el)}},onUploadComplete:function(e){if("success"in this.options&&typeof this.options.success==="function"){this.options.success(e)}}});JobEngine.Views.Modal_Box=Backbone.View.extend({defaults:{top:100,overlay:.5},$overlay:null,initialize:function(){_.bindAll(this);this.options=jQuery.extend(this.defaults,this.options);this.$overlay=jQuery("#lean_overlay");if(this.$overlay.length<=0){this.$overlay=jQuery("<div id='lean_overlay'></div>").appendTo("body")}this.$overlay.click(this.closeModal)},openModal:function(){var e=this;this.$overlay.css({display:"block",opacity:0}).fadeTo(200,this.options.overlay);this.$el.css({display:"block",position:"absolute",opacity:0,"z-index":11e3,left:50+"%","margin-left":-(this.$el.outerWidth()/2)+"px",top:$(window).scrollTop()+this.options.top+"px",width:this.options.width,height:this.options.height}).fadeTo(200,1,function(){e.$el.find("input[type=text]:first").focus()})},closeModal:function(e,t){var n=this;e=e||200,this.$overlay.fadeOut(200,function(){n.$el.hide();if(typeof t==="function"){t()}});return false}});JobEngine.Views.ModalReject=JobEngine.Views.Modal_Box.extend({el:jQuery("#modal-reject-job"),events:{"click div.modal-close":"closeModal","click a.cancel-modal":"closeModal","click #btn-reject":"reject"},initialize:function(){JobEngine.Views.Modal_Box.prototype.initialize.apply(this,arguments);this.options=_.extend(this.options,this.defaults);pubsub.on("je:job:afterRejectJob",this.afterRejectJob,this);this.loadingBtn=new JobEngine.Views.LoadingButton({el:this.$("input#btn-reject")})},onReject:function(e){this.model=e.model;this.$el.find("#job_title").html(this.model.get("title")).end().find("#company_name").html(this.model.get("author"));this.openModal()},reject:function(e){e.preventDefault();this.loadingBtn.loading();this.message=this.$el.find("textarea[name=reason]").val();this.refund=this.$el.find("input[name=refund]").val();var t=this;this.model.reject({data:{reason:t.message,refund:t.refund},silent:true})},afterRejectJob:function(){this.loadingBtn.finish();this.closeModal()}});JobEngine.Views.LoadingEffect=Backbone.View.extend({initialize:function(){},render:function(){this.$el.html(et_views.loadingImg);return this},finish:function(){this.$el.html(et_views.loadingFinish);var e=this;setTimeout(function(){e.$el.fadeOut(500,function(){$(this).remove()})},1e3)},remove:function(){view.$el.remove()}});JobEngine.Views.BlockUi=Backbone.View.extend({defaults:{image:et_globals.imgURL+"/loading.gif",opacity:"0.5",background_position:"center center",background_color:"#ffffff"},isLoading:false,initialize:function(e){e=_.extend(_.clone(this.defaults),e);var t=e.image;this.overlay=$('<div class="loading-blur loading"><div class="loading-overlay"></div><div class="loading-img"></div></div>');this.overlay.find(".loading-img").css({"background-image":"url("+e.image+")","background-position":e.background_position});this.overlay.find(".loading-overlay").css({opacity:e.opacity,filter:"alpha(opacity="+e.opacity*100+")","background-color":e.background_color});this.$el.html(this.overlay);this.isLoading=false},render:function(){this.$el.html(this.overlay);return this},block:function(e){var t=$(e);if(t.css("position")!=="absolute"||t.css("position")!=="relative"){t.css("position","relative")}this.isLoading=true;this.render().$el.show().appendTo(t)},unblock:function(){this.$el.remove();this.isLoading=false},finish:function(){this.$el.fadeOut(500,function(){$(this).remove()});this.isLoading=false}});JobEngine.Views.LoadingButton=Backbone.View.extend({dotCount:3,isLoading:false,initialize:function(){if(this.$el.length<=0)return false;var e=this.$el[0];if(this.$el[0].tagName=="INPUT"){this.title=this.$el.val()}else{this.title=this.$el.html()}this.isLoading=false},loopFunc:function(e){var t="";for(i=0;i<e.dotCount;i++)t=t+".";e.dotCount=(e.dotCount+1)%3;e.setTitle(et_globals.loading+t)},setTitle:function(e){if(this.$el[0].tagName==="INPUT"){this.$el.val(e)}else{this.$el.html(e)}},loading:function(){this.setTitle(et_globals.loading);this.$el.addClass("disabled");var e=this;e.isLoading=true;e.dots="...";e.setTitle(et_globals.loading+e.dots);this.loop=setInterval(function(){if(e.dots==="...")e.dots="";else if(e.dots==="..")e.dots="...";else if(e.dots===".")e.dots="..";else e.dots=".";e.setTitle(et_globals.loading+e.dots)},500)},finish:function(){var e=this.$el[0];this.isLoading=false;clearInterval(this.loop);this.setTitle(this.title);this.$el.removeClass("disabled")}});jQuery.fn.buttonLoading=function(){$(this).html(et_globals.loading)}