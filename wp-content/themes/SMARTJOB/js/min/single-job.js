jQuery(document).ready(function(e){JobEngine.Views.Single_Job=Backbone.View.extend({el:e("div.content-container"),events:{"click a[rel=modal-box]":"requestModal","click a#approveJob":"approveJob","click span.removeFile":"removeFile","click button.applyJob":"showApplyForm","click a.reminder":"showRemindForm","click button.cancel":"hideForm","submit form#applicationForm":"submitApplication","submit form#reminderForm":"submitReminder"},initialize:function(){_.bindAll(this);var t=this.$(".job-title"),n=this.$("span.job-info"),r=this.$("div.company-profile"),i=JSON.parse(this.$("#job_data").html()),s=JSON.parse(this.$("#company_data").html()),o=this.$("#apply_docs_container"),u=this;this.loadingBtn=new JobEngine.Views.LoadingButton({el:this.$el.find("button#apply")});this.model=new JobEngine.Models.Job(i);this.model.author.set(s);if(e("#modal_edit_job").length>0&&(typeof this.editModalView==="undefined"||!(this.editModalView instanceof JobEngine.Views.Modal_Edit_Job))){this.editModalView=new JobEngine.Views.Modal_Edit_Job}if(e("#modal-reject-job").length>0&&(typeof this.rejectModalView==="undefined"||!(this.rejectModalView instanceof JobEngine.Views.ModalReject))){this.rejectModalView=new JobEngine.Views.ModalReject}this.fileIDs=[];this.docs_uploader=new JobEngine.Views.File_Uploader({el:o,uploaderID:"apply_docs",multi_selection:true,unique_names:true,upload_later:true,filters:[{title:"Compressed Files",extensions:"zip,rar"},{title:"Documents",extensions:"pdf,doc,docx"}],multipart_params:{_ajax_nonce:o.find(".et_ajaxnonce").attr("id"),action:"et_upload_files"},cbAdded:function(t,n){var r=u.$("#apply_docs_file_list"),i;if(t.files.length>u.docs_uploader.MAX_FILE_COUNT){while(t.files.length>u.docs_uploader.MAX_FILE_COUNT){t.removeFile(t.files[t.files.length-1])}pubsub.trigger("je:notification",{msg:et_single_job.upload_file_notice+u.docs_uploader.MAX_FILE_COUNT+" files.",notice_type:"error"})}r.empty();for(i=0;i<t.files.length;i++){e(u.fileTemplate({id:t.files[i].id,filename:t.files[i].name,filesize:plupload.formatSize(t.files[i].size),percent:t.files[i].percent})).appendTo(r)}},cbRemoved:function(e,t){for(var n=0;n<t.length;n++){u.$("#"+t[n].id).remove()}},onProgress:function(e,t){u.$("#"+t.id+" .percent").html(t.percent+"%")},cbUploaded:function(e,t,n){if(n.success){u.fileIDs.push(n.data)}else{u.hasUploadError=true;pubsub.trigger("je:notification",{msg:n.msg,notice_type:"error"})}},onError:function(e,t){pubsub.trigger("je:notification",{msg:t.message,notice_type:"error"})},beforeSend:function(){u.loadingBtn.loading()},success:function(){}});this.docs_uploader.MAX_FILE_COUNT=3;pubsub.on("je:job:afterEditJob",this.render,this)},fileTemplate:_.template('<li id="<%= id %>"><span class="icon removeFile" data-icon="D"></span>'+'<span class="name"><%= filename %></span>'+'<span class="size"><%= filesize %></span>'+'<span class="percent"><%= percent %>%</span></li>'),removeFile:function(t){t.preventDefault();var n=e(t.currentTarget).closest("li").attr("id");for(i=0;i<this.docs_uploader.controller.files.length;i++){if(this.docs_uploader.controller.files[i].id===n){this.docs_uploader.controller.removeFile(this.docs_uploader.controller.files[i])}}},requestModal:function(t){t.preventDefault();var n=e(t.currentTarget).attr("href");switch(n){case"#modal_edit_job":this.editModalView.onEdit(this.model);break;case"#modal_reject_job":this.rejectModalView.onReject({model:this.model});break}},render:function(t){var n=this.$el.find("span#job_cat"),r=this.$el.find("span#job_type"),i=t.author.get("user_logo"),s=t.get("categories"),o=e.map(s,function(e,t){return e.slug}),u=t.get("prev_cats"),a=_.difference(o,u),f=e(".breadcrumb"),l=f.find("a.home").clone(),c=t.get("status"),h=t.get("prev_status");this.$el.find("#job_title").attr("data",t.id).text(t.get("title")).end().find("#job_location").text(t.get("location")).end().find("#job_description").html(t.get("content")).end().find(".job_author_link").attr({href:t.author.get("post_url"),title:t.author.get("display_name")}).end().find("#job_author_name").text(t.author.get("display_name")).end().find("#job_author_thumb img").attr({src:i.thumbnail[0],data:i.attach_id}).end().find("#job_author").find("#job_author_url").attr({href:t.author.get("user_url"),title:t.author.get("display_name")}).find("span:first").text(t.author.get("user_url")).end().end().find("#job_author_logo img").attr({src:i["company-logo"][0],data:i.attach_id});if(a&&a.length>0){f.empty().append(l).append(" Â» ").append('<a href="'+s[0].url+'">'+s[0].name+"</a>")}e.each(t.get("job_types"),function(){r.empty().append('<input class="job-type-slug" type="hidden" value="'+this.slug+'"/>'+'<a class="color-'+this.color+'" href="'+this.url+'" title="'+this.name+'"><span class="flag"></span>'+this.name+"</a>")});if(!!h&&h!==c){var p=this.$el.find("#adminAction"),d=this.$el.find(".message");if(p.length>0){if(p.is(":hidden")){if(c==="pending"){p.fadeIn("normal")}}else if(c!=="pending"){p.fadeOut("normal")}}if(d.length>0){if(c!=="publish"){if(d.is(":hidden")){d.slideDown("normal")}}else{if(d.is(":visible")){d.slideUp("normal")}}if(p.length===0&&c==="pending"){c="pending2"}this.$el.find(".message .text").html(et_single_job.info_job_statuses[c])}}},approveJob:function(e){var t=this;e.preventDefault();var n=new JobEngine.Views.BlockUi;this.model.approve({beforeSend:function(){n.block(t.$el.find(".job-controls"))},success:function(e,r){n.unblock();t.$el.find(".message").slideUp("normal").end().find("#adminAction").fadeOut("normal")}})},showApplyForm:function(t){t.preventDefault();this.$("div.form_container").children("div").hide().end().find("div#apply_form").fadeIn(200,this.initApplyFormValidator);e(window).scrollTop(e("#apply_form").offset().top-70-e("#wpadminbar").height())},initApplyFormValidator:function(){if(typeof this.application_validator==="undefined"){this.application_validator=this.$("form#applicationForm").validate({rules:{apply_name:{required:true},apply_email:{required:true,email:true}}})}},showRemindForm:function(e){e.preventDefault();this.$("div.form_container").children("div").hide().end().find("div#remind_form").fadeIn(200,this.initRemindFormValidator)},initRemindFormValidator:function(){if(typeof this.remind_validator==="undefined"){this.remind_validator=this.$("form#reminderForm").validate({rules:{share_email:{required:true,email:true}}})}},hideForm:function(e){e.preventDefault();this.$("div.form_container").children("div").hide().end().find("div#job_action").fadeIn(200)},submitApplication:function(e){var t=this;e.preventDefault();if(this.application_validator.form()){if(this.docs_uploader.controller.files.length>0){this.docs_uploader.controller.bind("StateChanged",function(e){if(e.files.length===e.total.uploaded){if(!t.hasUploadError){t.postApplication()}}});this.hasUploadError=false;this.docs_uploader.controller.start()}else{this.postApplication()}}},postApplication:function(){var t=this,n=this.$("#applicationForm");form_data={action:"et_apply_job",job_id:this.model.id,apply_name:n.find("input#apply_name").val(),apply_email:n.find("input#apply_email").val(),apply_note:n.find("textarea#apply_note").val(),attachments:this.fileIDs,_ajax_nonce:n.find(".et_ajaxnonce").attr("id")},loadingBtn=new JobEngine.Views.LoadingButton({el:n.find("button#apply")});e.ajax({type:"POST",url:et_globals.ajaxURL,data:form_data,contentType:"application/x-www-form-urlencoded;charset=UTF-8",beforeSend:function(){if(!self.loadingBtn.isLoading)self.loadingBtn.loading()},success:function(e,n,r){self.loadingBtn.finish();t.cbApplied(e)}})},cbApplied:function(e){if(e.success){this.$("#apply_form").hide();this.$("#success-msg").html(e.msg).show()}else{pubsub.trigger("je:notification",{msg:e.msg,notice_type:"error"})}},submitReminder:function(t){t.preventDefault();var n=new JobEngine.Views.LoadingButton({el:e("button#remind")});var r=e(t.currentTarget),i=this,s={type:"POST",url:et_globals.ajaxURL,data:r.serialize(),contentType:"application/x-www-form-urlencoded;charset=UTF-8",beforeSend:function(){n.loading()},success:function(e){n.finish();if(e.success){i.$("#remind_form").hide();i.$("#success-msg").html(e.msg).show()}else{pubsub.trigger("je:notification",{msg:e.msg,notice_type:"error"})}}};e.ajax(s)}});new JobEngine.Views.Single_Job})