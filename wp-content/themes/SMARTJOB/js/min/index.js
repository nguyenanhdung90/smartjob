jQuery(document).ready(function(e){JobEngine.Views.Index=Backbone.View.extend({el:e("body"),events:{"click div.button-more button":"loadMore","keyup input.search-box":"searchJob",'click ul.filter-joblist li a:not(".et_processing")':"filterHandler"},initialize:function(){var t=JSON.parse(this.$("#latest_jobs_data").html()),n=this.$("#pending_jobs_data"),r;this.previous={s:this.$("input.search-box[name=s]").val(),job_location:this.$("input.search-box[name=job_location]").val()};_.bindAll(this);this.companies_data=JSON.parse(this.$("#companies_data").html());if(n.length!==0){n=JSON.parse(n.html());r=function(e){var t=new Date(e.get("post_date"));return-parseInt(e.get("job_paid")+""+t.getTime(),10)};this.pendingJobs=new JobEngine.Collections.Jobs(n,{comparator:r})}else{this.pendingJobs=new JobEngine.Collections.Jobs;this.pendingJobs.comparator=r}this.pendingJobsView=new JobEngine.Views.JobListView({el:e("#pending_jobs_container"),collection:this.pendingJobs});$isPublishedList=t.status==="publish";if($isPublishedList){this.activeJobs=new JobEngine.Collections.Jobs(t.jobs);this.curJobs=this.activeJobs;this.otherJobs=new JobEngine.Collections.Jobs}else{this.otherJobs=new JobEngine.Collections.Jobs(t.jobs);this.curJobs=this.otherJobs;this.activeJobs=new JobEngine.Collections.Jobs}this.activeJobsView=new JobEngine.Views.JobListView({el:e("#latest_jobs_container"),collection:this.activeJobs});this.otherJobsView=new JobEngine.Views.JobListView({el:e("#latest_jobs_container"),collection:this.otherJobs});if($isPublishedList){this.otherJobsView.undelegateEvents()}else{this.activeJobsView.undelegateEvents()}this.curJobs.setData(this.buildParams());pubsub.on("je:job:afterRemoveJobView",this.afterRemoveJobView,this);pubsub.on("je:job:afterApproveJob",this.afterApproveJob,this);pubsub.on("je:job:onReject",this.onRejectJob,this);pubsub.on("je:job:afterRejectJob",this.afterRejectJob,this);pubsub.on("je:job:afterToggleFeature",this.afterToggleFeature,this);pubsub.on("je:job:afterArchiveJob",this.afterArchiveJob,this);if(this.$("#modal_edit_job").length>0&&(typeof this.editModalView==="undefined"||!(this.editModalView instanceof JobEngine.Views.Modal_Edit_Job))){this.editModalView=new JobEngine.Views.Modal_Edit_Job;pubsub.on("je:job:onEdit",this.onEditJob,this);pubsub.on("je:job:afterEditJob",this.afterEditJob,this)}},afterRemoveJobView:function(e){var t=e.get("status"),n=this.$("ul.filter-jobstatus");switch(t){case"pending":this.pendingJobs.add(e);if(this.pendingJobs.length>0){if(this.pendingJobsView.$el.is(":hidden")){this.pendingJobsView.$el.fadeIn("fast")}}break;case"publish":if(n.find("li a.active").length===0){this.activeJobs.unshift(e)}break;default:if(n.find("li.status-"+t+" a.active").length>0){this.otherJobs.add(e)}break}},afterApproveJob:function(e,t){var n=e.get("categories"),r=this,i=this.$("ul.filter-jobcat"),s;this.pendingJobs.remove(e);if(_.isArray(n)){for(s=0;s<n.length;s++){if("slug"in n[s]){i.find("li.cat-"+n[s].slug+" span.count").each(r.countUp)}}}},onRejectJob:function(e){if(typeof this.rejectModalView==="undefined"||!(this.rejectModalView instanceof JobEngine.Views.ModalReject)){this.rejectModalView=new JobEngine.Views.ModalReject}this.rejectModalView.onReject(e)},onEditJob:function(e){var t=e.get("author_id"),n=t in this.companies_data?this.companies_data[t]:null;this.editModalView.onEdit(e,n)},afterRejectJob:function(t,n){this.pendingJobs.remove(t);e("ul.filter-jobstatus > li.status-reject").each(function(){var t=e(this),n=t.find("span.count"),r=parseInt(n.html(),10);r++;n.html(r)})},afterArchiveJob:function(t,n,r){var i=e("ul.filter-jobstatus > li.status-archive"),s=i.find("a.active").length;if(s===0){this.curJobs.remove(t)}i.each(function(){var t=e(this),n=t.find("span.count"),r=parseInt(n.html(),10);r++;n.html(r)});if(r==="reject"){e("ul.filter-jobstatus > li.status-reject").each(function(){var t=e(this),n=t.find("span.count"),r=parseInt(n.html(),10);r--;n.html(r)})}},afterToggleFeature:function(e,t){var n=e.collection;n.remove(e)},filterHandler:function(t){t.preventDefault();var n=e(t.currentTarget);if(!n.hasClass("et_processing")){n.addClass("et_processing");n.toggleClass("active");this.filter({success:function(){setTimeout(function(){n.removeClass("et_processing")},50)}})}},searchJob:function(t){t.preventDefault();var n=this,r=e(t.currentTarget),i=r.attr("name");value=e(t.currentTarget).val();if(value==this.previous[i])return false;else{this.previous[i]=value}if(typeof this.t!=="undefined"){clearTimeout(this.t)}this.t=setTimeout(function(){n.filter()},700)},buildParams:function(){var t={},n=this.$("ul#status_filter a.active"),r=this.$("ul#jobtype_filter a.active"),i=this.$("#jobcat_filter a.active"),s=this.$("input.job-searchbox");if(r.length>0){t.job_type=e.map(r,function(t){return e(t).attr("data")})}if(i.length>0){t.job_category=e.map(i,function(t){return e(t).attr("data")})}if(n.length>0){t.status=e.map(n,function(t){return e(t).attr("data")});this.curJobs=this.otherJobs;this.activeJobsView.undelegateEvents();this.otherJobsView.delegateEvents()}else{t.status=["publish"];this.curJobs=this.activeJobs;this.otherJobsView.undelegateEvents();this.activeJobsView.delegateEvents()}e.each(s,function(){var e=jQuery(this),n=e.attr("name"),r=e.attr("placeholder"),i=e.val();if(i!==""&&i!==r){if(n==="job_location"){t.location=i}else{t[n]=i}}});return t},filter:function(t){var n=this.buildParams();this.curJobs.setData(n);this.curJobs.filter(t);if("job_type"in n){n.job_type=n.job_type.join(",")}if("job_category"in n){n.job_category=n.job_category.join(",")}if("status"in n){n.status=n.status.join(",");if(n.status==="publish"){delete n.status}}if("paged"in n&&n.paged===1){delete n.paged}if(n&&Modernizr&&Modernizr.history){Backbone.history.navigate("?"+e.param(n,true))}},loadMore:function(t){var n=e(t.currentTarget);t.preventDefault();if(!n.hasClass("et_processing")){n.addClass("et_processing");this.curJobs.nextPage({success:function(t,r){if(t.paginateData.paged>=t.paginateData.total_pages){e("div.button-more").hide()}else{e("div.button-more").show()}n.removeClass("et_processing")}})}},afterEditJob:function(t){var n=e.map(t.get("categories"),function(e,t){return e.slug}),r=t.get("prev_cats"),i=this.$("ul.filter-jobcat"),s=this.$("ul.filter-jobstatus"),o=t.get("prev_status"),u=t.get("status"),a=this,f,l,c,h;if(o!==u){l=s.find("li a.active").length;if(o==="publish"&&l===0||l===1||l===2&&u!=="reject"&&u!=="archive"){this.curJobs.remove(t)}if(o==="publish"){e.each(r,function(e,t){i.find("li.cat-"+t+" span.count").each(a.countDown)})}if(u==="publish"){e.each(n,function(e,t){i.find("li.cat-"+t+" span.count").each(a.countUp)})}s.find("li.status-"+o+" span.count").each(this.countDown);s.find("li.status-"+u+" span.count").each(this.countUp)}else{if(u==="publish"){c=_.difference(r,n);e.each(c,function(e,t){i.find("li.cat-"+t+" span.count").each(a.countDown)});h=_.difference(n,r);e.each(h,function(e,t){i.find("li.cat-"+t+" span.count").each(a.countUp)})}}},countUp:function(t,n){var r=e(n),i=parseInt(r.html(),10);i++;r.html(i)},countDown:function(t,n){var r=e(n),i=parseInt(r.html(),10);i--;r.html(i)}});JobEngine.Routers.Index=Backbone.Router.extend({routes:{"filter/:value":"filterCompany"},initialize:function(){},filterCompany:function(t){e("ul.list-alphabet li a[data="+t.toUpperCase()+"]").trigger("click")}});new JobEngine.Views.Index;if(typeof Modernizr!=="undefined"&&Modernizr.history===true){new JobEngine.Routers.Index;Backbone.history.start({pushState:true,hashChange:false,root:et_index.routerRootIndex})}})